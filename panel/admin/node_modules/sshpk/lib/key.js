// Copyright 2018 Joyent, Inc.

module.exports = Key;

var assert = require('assert-plus');
var algs = require('./algs');
var crypto = require('crypto');
var Fingerprint = require('./fingerprint');
var Signature = require('./signature');
var DiffieHellman = require('./dhe').DiffieHellman;
var errs = require('./errors');
var utils = require('./utils');
var PrivateKey = require('./private-key');
var edCompat;

try {
	edCompat = require('./ed-compat');
} catch (e) {
	/* Just continue through, and bail out if we try to use it. */
}

var InvalidAlgorithmError = errs.InvalidAlgorithmError;
var KeyParseError = errs.KeyParseError;

var formats = {};
formats['auto'] = require('./formats/auto');
formats['pem'] = require('./formats/pem');
formats['pkcs1'] = require('./formats/pkcs1');
formats['pkcs8'] = require('./formats/pkcs8');
formats['rfc4253'] = require('./formats/rfc4253');
formats['ssh'] = require('./formats/ssh');
formats['ssh-private'] = require('./formats/ssh-private');
formats['openssh'] = formats['ssh-private'];
formats['dnssec'] = require('./formats/dnssec');
formats['putty'] = require('./formats/putty');
formats['ppk'] = formats['putty'];

function Key(opts) {
	assert.object(opts, 'options');
	assert.arrayOfObject(opts.parts, 'options.parts');
	assert.string(opts.type, 'options.type');
	assert.optionalString(opts.comment, 'options.comment');

	var algInfo = algs.info[opts.type];
	if (typeof (algInfo) !== 'object')
		throw (new InvalidAlgorithmError(opts.type));

	var partLookup = {};
	for (var i = 0; i < opts.parts.length; ++i) {
		var part = opts.parts[i];
		partLookup[part.name] = part;
	}

	this.type = opts.type;
	this.parts = opts.parts;
	this.part = partLookup;
	this.comment = undefined;
	this.source = opts.source;

	/* for speeding up hashing/fingerprint operations */
	this._rfc4253Cache = opts._rfc4253Cache;
	this._hashCache = {};

	var sz;
	this.curve = undefined;
	if (this.type === 'ecdsa') {
		var curve = this.part.curve.data.toString();
		this.curve = curve;
		sz = algs.curves[curve].size;
	} else if (this.type === 'ed25519' || this.type === 'curve25519') {
		sz = 256;
		this.curve = 'curve25519';
	} else {
		var szPart = this.part[algInfo.sizePart];
		sz = szPart.data.length;
		sz = sz * 8 - utils.countZeros(szPart.data);
	}
	this.size = sz;
}

Key.formats = formats;

Key.prototype.toBuffer = function (format, options) {
	if (format === undefined)
		format = 'ssh';
	assert.string(format, 'format');
	assert.object(formats[format], 'formats[format]');
	assert.optionalObject(options, 'options');

	if (format === 'rfc4253') {
		if (this._rfc4253Cache === undefined)
			this._rfc4253Cache = formats['rfc4253'].write(this);
		return (this._rfc4253Cache);
	}

	return (formats[format].write(this, options));
};

Key.prototype.toString = function (format, options) {
	return (this.toBuffer(format, options).toString());
};

Key.prototype.hash = function (algo, type) {
	assert.string(algo, 'algorithm');
	assert.optionalString(type, 'type');
	if (type === undefined)
		type = 'ssh';
	algo = algo.toLowerCase();
	if (algs.hashAlgs[algo] === undefined)
		throw (new InvalidAlgorithmError(algo));

	var cacheKey = algo + '||' + type;
	if (this._hashCache[cacheKey])
		return (this._hashCache[cacheKey]);

	var buf;
	if (type === 'ssh') {
		buf = this.toBuffer('rfc4253');
	} else if (type === 'spki') {
		buf = formats.pkcs8.pkcs8ToBuffer(this);
	} else {
		throw (new Error('Hash type ' + type + ' not supported'));
	}
	var hash = crypto.createHash(algo).update(buf).digest();
	this._hashCache[cacheKey] = hash;
	return (hash);
};

Key.prototype.fingerprint = function (algo, type) {
	if (algo === undefined)
		algo = 'sha256';
	if (type === undefined)
		type = 'ssh';
	assert.string(algo, 'algorithm');
	assert.string(type, 'type');
	var opts = {
		type: 'key',
		hash: this.hash(algo, type),
		algorithm: algo,
		hashType: type
	};
	return (new Fingerprint(opts));
};

Key.prototype.defaultHashAlgorithm = function () {
	var hashAlgo = 'sha1';
	if (this.type === 'rsa')
		hashAlgo = 'sha256';
	if (this.type === 'dsa' && this.size > 1024)
		hßİß_îü7ìûùûóìŞÿïéWv§Kk}Y÷İÿg×*{ëøróŞ®¦mõgîøÏ[İòü4—¶áıÛ~Û%ıÿNÇko·õÖš¾×ğïÊ»şxı¶óë½äï»Ÿ8ı-ôæà¶#½ßtÅÑÛ¾«>Ç’oüÑ4İÿûïÿ¦÷´ÿ­¶Ñùs/lúªÖ^éj™|÷7Z;tOñ«Nøı jz.öwBMöÀ0Ëşsßş³rï°[ûïãqySg›mÇNÑ»•lĞkßw˜û¨¼ë1œ†½´b/NSëÛÛİ_xôÓÖØ-Ô7˜¾0¯0Ãë:‡KH¢j½û<o•{³_FUÕ¸r»ú?¹Ñ¶bŞ¾kÖ5Åj×ı*_tc¨İ?õ;,$jÜ—Í%—²Úö¸Ù§ò‡êğ;øÿvGökşøßRÕ³ôÿïø¯ÎxÏkwGÿùô}±¾ñx³.|Ul‡,?õÑ2¹¾{7Ûıcá/§Ø¾wüû›nÿöBûóŒZşwıªy·úÉJÚ®“û'»¶®û?Ó«^ƒ{'‹¾¿$‡ëŸùÎ=
õŸà'ùùù“×òzê¿>ÏËŸsUŒıåí ]]™ı;ß¿}õı{şÛ_zßk&B÷û8Óme¿¤ë~=×ŸÍÏû÷îÛ—Óú÷ıìJ}_ŞîÚÛZ‰üÿüXŸjñÏkŞqq^ö†}uğó³Çe¿{ß¤YöŞûÛßE×ñÆúÆâEé‡Ãï'nwOñß)wıy…âß<bMt(j¶£o…İÎË7äıOJ¸}½9İú[3mRSZÿ¯Nõ9¼ëü·íÿT1ÿövæ«gßÅRÙòzsÿ;²ùËßã^bxõ¢ûõ¼Ûş½¿íÿ¸¯ÓøÙ?gŠßWş>ÏW×á¿ÍæşûÏÿ÷/;Ÿßö÷İşîşÕ×?÷›Ô§Í>vÍk_?÷gŒú×g¼ûÚvïŞşw?ùÃ_çìÿå˜+dôôPã‘¹o{İßïnû}ûÛ]ıÇOİùÅò¼õéü/÷u¿ÿ¿ìäò3ŞÍ½£÷t¤ÄİÇæşá¿¤Ç¿¼o¯<şÎİşeûôµıv7Wõ²İŞ‡ì¾¿ÑõåşÛSiÄ×çö×-Û·çß÷ìçİ¹K¿h{3–ûN²èıuÿõùöæÿ<tíşùùoïiıÏ¼ö5}Şİôõ¿ûşåûæı¿uïê-sÿ³¹o&·Ø‡¹\s¦¬ıÃhÿú—½ù9~/í»Û«û›å÷ÿ¿Kæ+-°{íım•ïÌçiñF¾Ú?}WÙ®=î›+\=Ën¶±ªÿÿ8ßö(Ö²Ù]?ç‹¾ÿÃáÓïïc;__¯»SgŸa€]ñ°óÿşI×zíıWãNõ¼¿ä‰İºUÓx½«çú¾“ÚÇ_÷âõ{';ÜÿõÏRE/*·Î€Ûò/÷÷øgşÒ:³ûİÏı¸+FsóÅgwÕ÷¿ÿ>ŠóüïØvCûñc¿öŸö{›.şon9ßÿòıöÿıWşof¿o÷¾—wôŞÿÔ¬ª»vvÎü_KçéíVÿŸO›Äş'\çş¯~ËiÿÇj^°Ö]]©</ìE±ş™³_ı×ûgÿ
?ãóQ´„gãö@NµÓÓÃàhî0ÿcîoAŸ·ñ?8§¤sfoMRpgIşol¸n¨âm¡ØOé+ê?{óÖg§¹¤/­?òß­Àoûè×NÖ¶¿úöûó÷w×?lÑ|øù¿·yß‘óÜk·¡ì×ÿöò÷Ü÷=ï/Y¿}òûşO¦ñgnî¶Œ¿ÿßÖÇ¯ó\ÚßîºÑÉ^ñ¯¿÷«øµµkşçÇlóÜcoıç³¨¶¾~j)÷ µò¿É‡_¦Íìú»ß<zä·{»ßIg­Oï=Fï8÷woµ8?y–¿}õÅFûğüÍë¾tso×2÷û.ö¯ooM—Óáù©ı=?ë/½½ïş}Ù\ùûÓü·Fşù5ú\š_}ëî~Óoÿb¹d}LS·’çÎæNJ‚ÿ÷úÿÿk1º§Õ~ïüİ¿tùáw¿=¿í;wûykÿ?Üÿ=nwE÷DúÿWÀ½è†·²÷+ªë¾™<[oy“ÿ¨r×¯¹L‡èŸäòşû¾ÔoñÂ•ûÜ§ıø¯ßÚ~®ÿüê¿ôÑ)ûˆ'cwYYM¾•Õ·ùçuÍB¯ieœiï9µy^l®M¬ÑÛÓKÅºİ¾üÀ¦6oÿ·ôÉ½ó»?Æï‰_×¨şÚ
ó¶k¥²½Çôç½ò<Ş=z½ªïöíuøşî¿.Iêû|Ö&”°ı«ÛœÅ‡o_¾¶>Ÿèúôë_ÿö¿ëÿnùgçüâ->×ÿçÏÙ¹¶û«Î¯/üúğõ||S“_ÿûßÓõû§ïyû³ûï¿Ìİÿ×ö}=:Ïû¶oşW=[‡Şî¿nïı¶ÿñïï6©+÷ÿæşo—dï\ıuÍÍ³»è}ì(½OÖû?ù›û·ïßÿ?s¹/èLü¶ØVŞ¦(×õı7ış½Ç¾İûï»şÒŞÿŸLòS?ïê½¯òån¸#~üşï{íêº÷ßûM_E÷~?f\÷;şwÃ]ş»yõ{­4÷ìÑm§õwuŞ_µÿ'ˆÿ«».ş¶?úº\^]‡¿_Ü~ñÿÅKı«7×‘Ôé®½ê'Ï*ÿ-üQ¯”ï`º½›Ôëı/§ğ;yÃËq¿u¹Ë5ŞmÏ¯O‘Ññ×ç;zzÖï.–Å‰ş?_îÔŸûõÜí¯İŸÓßùgûeı;šm\^®¿GÜ>‡ß^ş»Òò«ÿ÷ÿîû¿ÜvG÷KyÇã{ëòşù3ù¼®n_¯:\¿çW®ÿï=ù]³7=ÚóÌ§ğûïM"ôóÇé<ÏºUEÿw¶wí÷{­ê¥}yfÙ}×Øõ7ıÊŸéôÛ»FY~ï¬ïı¹Ôä_¹ÑÏüãÏïoìßáí¦şú-Üû<WßßÿOõoy­çİRü\W·ÛæŸâ©â?CıÖŸO<‘÷éöNı¿¬÷É¾ñôïó÷ªÇ’ïŸë÷åÿóªÏk)Ú¹şğq¥×”k¿~±ôwoÏïÈîëÂO¾ìú<L5İ¼ÆôóÛy²=~¾ÿÙº[ë¸Ûğo_Ç¼İØ¯Íëıº}Ö¿ÿÚ’÷’½Ã9÷ûôó¾.ôjUÓñÖün×Ë—¶ÿñ×ÿ–ÓKÏêmï³İ0ì+ìHÏwp+Ç¼şâxÍ˜hæ=µjü’~“7¼u¤•_q^ôo¾sræòå÷{}ÚèDÏgişí÷ù®üÙ­sêã>ïoôöwùl{åæsÿz}ãa÷{ü:şWwgúßs¿yğyïİİõÿÿPm××8·¼_Õ]¯Öø÷W´Ì÷G¹Á~ÎİîúìıïÛÜş»Ï^·<¢ü¥û°nÿ¼qOí¾ƒöÉşsıÿo•õ|Ö¿·ß©Çvë¦ŸHxŠrÜœüûÑ{€z½öëW¸ÿ?ôJ,ß¿ûükÚÿ{yÄİïÏbu#66áq‡mê•ÌM­Oéi/;•£WÌ7˜Ï´§ï¤ƒãpØØ4®Ÿ‘ ÍşóP4ßs¬6á§hÿCV¹s5çgü.¸G²¥»ßæ“°ú5–…z©|ÙZşô«·ëßyŞÿUóÿ/÷¾Óşÿæ÷wÏ½·go«Ïı¼ı}ùşë?ûÿê~Æ?uä‡ïú©ûÍyòùû9´ê\Ÿµè8/ÕßW¹ÉgÆÿŞÛó.7ªbù§·~$ìõáêİøZÑ·ô–ş”¿=m¿¿ofß_Ôÿ¶lGvÇwÿÿ¯ŸÉ{?âvÖ[ç¿Õ8õ¶Q:¹Q|÷ş}ßsÙ¯{õ½?ßŸ¢Gk0õ
Ÿï¹÷—×ç*ûWç«¿ôÛõ6õş»kñëw0¼ÿ(¿ø=oïó¯ìòçLŒáµÈúo·ßoœËùŞÿŞ«¯ò|?:›¿Ê<õzéO{ÇgÓMû®xÏí“Ç²Wß_Ğ¯VhÊ¿ßôxsş„n¯_·ü¿ø¢¶_×¢ş¾û™?ğ»ö"×_uøw¸½r,ËÉ‡µsşhïûxó÷Ê/şóÍÛ›Sµj–>şW»íÄZ»vš;jyc¡ó>n~ù½ÛZöë¾?»G†ÉßÓÚÛ'Û¦/B_ÌH-ñ\µkî0$»Ÿ†ÿÇïÿiBŞİë+ÿåy¶R»w{‡ê˜)_û¡¯–z¾ÿÎöl­6¿şÛòÿæüÿÖÿeUÏLêüóå#÷}÷çıöÊ-‡Î›ÜF·î¤ší¼3ïÿ{î¯úôÿê³×ıú™úé;Ú=İüÎå"ÿú÷=óo{m²}|=³ûo5m÷vëgî`¿eÇGü}±g¹#)nIQÑÜçsw©_Åwz—G
zÔ¶øş*oÿÔtîıuMµ;ıW¥ÎÿGí¿;fVØëw~~?¥¯£7OêêÑóÃOşZ¡Şâs“O§ÓúıÏ_Ô|woÿúöƒúUŠóÛo¸ıÛ¥ØFw™ÿÿÿûR÷ê¿ıOğôäÊwóú{¼â¶Èm¯¼CùıÅÎG³&ñÿ{[&ñÒÂé{}»ï×_oû_Ï.çM¿Óc»®û8ë­‡¼³ëøÛ"æ•kqjåGj¯øë‘ÚÓ_ßï7Ëü¿Í¨½Ã×êŸö¬kÿp\Rşò8W÷×¿÷ë\‹W×ªo„ü¼:üü?ßãÍı}‹ç>×çÿöûĞîãäşŸŸq="şûÿ—şç_û÷ÉõÿG÷Ú…ï»ş÷onî^Gıê}×ÿ?®ßÒŠÎ]ù·Åş¾§‘ëû^W_¯Ş'õ~oïïïënçûúOûÍ÷Îx~í^gúıüDå_û6rÖ5ÏŸ®±Ğæ2ïC[~Ï¯ãöÂÏŒÙş[ÿ¸|+ã.'wı;&ïi#Ò]ö	ßvÔ‰ÿ—¾»¶§s=³ïé‹â}ßöÛîïnû_E—ûÿE¶ƒ<ü{–•¡qbùş|›K’Rn+ÛÅÀ…ßO÷ĞlOE÷Ö~Ù“/A}«ß®»ÿïûš=ßşˆûQ×üı”owîõg“ıÛı³‹sÛmÏŒ-G·¤ÛÓ×Şç^ï‹ş··ÓïËëç×ßHÓ”=û÷ŞOŸzš»²OêKıKı4çïBæîÙeëüıİÚtNƒ·ºlşïw^°r×îë„ÑûºıòÑØ}ßnrÏ¯*¸ÊŸë»ïÙÿ·ËF¾ï?¶Ë(>;Ş_¾sïu¿Şfşù¬öÿÙûïõõıîËö}¿Ş½|?ÖÿöS¯ñÎ/ÓÇïw5Š?Ï¿wçóg¶o/ıû}o¥ÿ¶—´?õ}ïÅ}G—S½ïúzÙ÷0ú¯»û[şÚÿOÊZîo“l¿}ÙÛı)ø“«ó”ÛjşæwÛìÍ<ï(U¹ıûÎ÷à]oÙAM‹Ï¿üİşü«8¡:Fóß}?1ó=÷{